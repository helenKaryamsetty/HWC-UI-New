<form #prescriptionForm="ngForm" class="m-t-20">
  <section class="row no-row">
    <div class="row">
      <div
        class="col-sm-12 step-btn m-b-10"
        *ngIf="
          referredVisitCode !== 'undefined' &&
          referredVisitCode !== undefined &&
          referredVisitCode !== null
        "
      >
        <button
          mat-raised-button
          color="primary"
          class="pull-right"
          (click)="loadMMUPrescription()"
        >
          {{ current_language_set?.loadMMUPrescription }}
        </button>
      </div>
    </div>
    <div class="col-md-3" style="padding-bottom: 8px">
      <div *ngIf="isStockAvalable === 'primary'">
        <mat-icon
          style="
            background-color: green;
            color: white;
            font-size: 20px;
            height: 20px;
            width: 20px;
          "
          class="md-18"
        >
          check
        </mat-icon>
        <span style="color: green; padding-left: 1px">{{
          current_language_set?.stockAvailability
        }}</span>
      </div>
      <div *ngIf="isStockAvalable === 'warn'">
        <mat-icon
          style="
            background-color: #c30d0d;
            color: white;
            font-size: 20px;
            height: 20px;
            width: 20px;
          "
          class="md-18"
        >
          close </mat-icon
        ><span style="color: #c30d0d; padding-left: 5px">{{
          current_language_set?.stockAvailability
        }}</span>
      </div>
    </div>
  </section>
  <section class="row no-row">
    <div class="col-md-3 box">
      <mat-select
        class="input-full-width"
        name="form"
        [(ngModel)]="currentPrescription.formName"
        placeholder="{{ current_language_set?.Prescription?.form }}"
        (change)="getFormValueChanged()"
        required
      >
        <mat-option
          *ngFor="let item of drugFormMaster"
          [value]="item.itemFormName"
        >
          {{ item.itemFormName }}
        </mat-option>
      </mat-select>
    </div>

    <div class="col-md-3 box">
      <mat-form-field class="input-full-width">
        <input
          autocomplete="off"
          type="text"
          name="medicine"
          class="button-overall-disabled"
          [disabled]="!currentPrescription.formID"
          matInput
          [(ngModel)]="tempDrugName"
          (keyup)="filterMedicine(tempDrugName)"
          placeholder="{{ current_language_set?.Prescription?.medicine }}"
          (blur)="reEnterMedicine()"
          required
          [matAutocomplete]="autoGroup"
        />
        <mat-autocomplete
          #autoGroup="matAutocomplete"
          [displayWith]="displayFn"
        >
          <mat-option
            *ngFor="let item of subFilteredDrugMaster"
            [value]="item"
            (onSelectionChange)="selectMedicineObject($event)"
          >
            {{ item.itemName }} {{ item.strength }}{{ item.unitOfMeasurement }}
            {{ item.quantityInHand ? "(" + item.quantityInHand + ")" : "" }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>

    <div class="col-md-2 box">
      <mat-select
        class="input-full-width"
        name="dose"
        [(ngModel)]="currentPrescription.dose"
        [disabled]="!currentPrescription.drugID"
        placeholder="{{ current_language_set?.Prescription?.dosage }}"
        required
      >
        <mat-option
          *ngFor="let item of filteredDrugDoseMaster"
          [value]="item.drugDose"
        >
          {{ item.drugDose }}
        </mat-option>
      </mat-select>
    </div>

    <div class="col-md-4 box">
      <mat-select
        class="input-full-width"
        name="frequency"
        [(ngModel)]="currentPrescription.frequency"
        [disabled]="!currentPrescription.drugID"
        placeholder="{{ current_language_set?.Prescription?.frequency }}"
        required
      >
        <mat-option
          *ngFor="let item of drugFrequencyMaster"
          [value]="item.frequency"
        >
          {{ item.frequency }}
        </mat-option>
      </mat-select>
    </div>
  </section>

  <section class="row no-row" style="margin-top: 10px !important">
    <div class="col-md-3 box">
      <mat-select
        class="input-full-width"
        name="duration"
        [(ngModel)]="currentPrescription.duration"
        [disabled]="!currentPrescription.drugID"
        placeholder="{{
          current_language_set?.nurseData?.chiefComplaintsDetails?.duration
        }}"
        [required]="prescriptionForm.value.frequency !== 'SOS'"
      >
        <mat-option *ngFor="let item of drugDurationMaster" [value]="item">
          {{ item }}
        </mat-option>
      </mat-select>
    </div>

    <div class="col-md-3 box">
      <mat-select
        class="input-full-width"
        name="unit"
        [(ngModel)]="currentPrescription.unit"
        placeholder="{{ current_language_set?.Prescription?.unit }}"
        [disabled]="!currentPrescription.drugID"
        [required]="prescriptionForm.value.frequency !== 'SOS'"
      >
        <mat-option
          *ngFor="let item of drugDurationUnitMaster"
          [value]="item.drugDuration"
        >
          {{ item.drugDuration }}
        </mat-option>
      </mat-select>
    </div>

    <div
      class="col-md-2 box"
      *ngIf="
        currentPrescription.formID &&
        currentPrescription.formID !== '1' &&
        currentPrescription.formID !== '2'
      "
    >
      <mat-select
        class="input-full-width"
        name="quantity"
        [(ngModel)]="currentPrescription.qtyPrescribed"
        [disabled]="!currentPrescription.drugID"
        placeholder="{{ current_language_set?.Prescription?.quantity }}"
        required
      >
        <mat-option
          *ngFor="let item of drugDurationMaster | slice: 0 : 5"
          [value]="item"
        >
          {{ item }}
        </mat-option>
      </mat-select>
    </div>

    <div
      class="box"
      [ngClass]="{
        'col-md-6':
          !currentPrescription.formID ||
          (currentPrescription.formID && currentPrescription.formID <= '2'),
        'col-md-4':
          currentPrescription.formID && currentPrescription.formID > '2'
      }"
    >
      <mat-select
        class="input-full-width"
        name="route"
        [(ngModel)]="currentPrescription.route"
        placeholder="{{ current_language_set?.Prescription?.Route }}"
        [disabled]="!currentPrescription.drugID"
      >
        <mat-option
          *ngFor="let item of drugRouteMaster"
          [value]="item.routeName"
        >
          {{ item.routeName }}
        </mat-option>
      </mat-select>
    </div>
  </section>

  <section class="row no-row" style="margin-top: 10px !important">
    <div class="col-md-10 box">
      <mat-form-field class="input-full-width">
        <textarea
          matInput
          allowText="textAreaValidator"
          defaultNull
          matTextareaAutosize
          name="instructions"
          maxlength="300"
          name="instructions"
          [disabled]="!currentPrescription.drugID"
          [(ngModel)]="currentPrescription.instructions"
          placeholder="{{ current_language_set?.Prescription?.instructions }}"
        >
        </textarea>
      </mat-form-field>
    </div>
    <div class="col-md-2 box centered-button">
      <button
        id="add-button"
        class="button-add-disabled"
        [disabled]="prescriptionForm.invalid"
        md-raised-button
        color="primary"
        type="button"
        (click)="submitForUpload()"
      >
        {{ current_language_set?.common?.add }}
      </button>
    </div>
  </section>
</form>

<div *ngIf="drugPrescriptionForm.controls.prescribedDrugs.value.length > 0">
  <hr />
  <div [formGroup]="drugPrescriptionForm">
    <div class="row" formArrayName="prescribedDrugs">
      <div
        class="col-xs-12"
        *ngFor="
          let drug of drugPrescriptionForm?.controls.prescribedDrugs?.controls;
          let j = index
        "
      >
        <ng-container
          [formGroupName]="j"
          *ngIf="j >= pageLimits[0] && j < pageLimits[1]"
        >
          <fieldset
            class="m-b-20"
            [ngClass]="{ fieldset: drug.value.createdBy }"
          >
            <legend>
              {{ drug.value.drugName }} {{ drug.value.drugStrength }}
              {{ drug.value.isEDL ? "" : current_language_set?.nonEDLMedicine }}
            </legend>
            <div class="row">
              <div class="col-md-1">
                <mat-form-field class="input-full-width">
                  <input
                    autocomplete="off"
                    readonly="true"
                    type="text"
                    matInput
                    formControlName="formName"
                    placeholder="{{ current_language_set?.Prescription?.form }}"
                  />
                </mat-form-field>
                <!-- {{drug.value.formName}} -->
              </div>
              <div class="col-md-2">
                <mat-form-field class="input-full-width">
                  <input
                    autocomplete="off"
                    readonly="true"
                    type="text"
                    matInput
                    formControlName="dose"
                    placeholder="{{ current_language_set?.casesheet?.dose }}"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-2">
                <mat-form-field class="input-full-width">
                  <input
                    autocomplete="off"
                    readonly="true"
                    type="text"
                    matInput
                    formControlName="frequency"
                    placeholder="{{
                      current_language_set?.Prescription?.frequency
                    }}"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-2">
                <mat-form-field class="input-full-width">
                  <input
                    autocomplete="off"
                    readonly="true"
                    type="text"
                    matInput
                    formControlName="durationView"
                    placeholder="{{
                      current_language_set?.nurseData?.chiefComplaintsDetails
                        ?.duration
                    }}"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-1">
                <mat-form-field class="input-full-width">
                  <input
                    autocomplete="off"
                    readonly="true"
                    type="text"
                    matInput
                    formControlName="qtyPrescribed"
                    placeholder="{{
                      current_language_set?.Prescription?.quantity
                    }}"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-3">
                <mat-form-field class="input-full-width">
                  <input
                    autocomplete="off"
                    readonly="true"
                    type="text"
                    matInput
                    formControlName="instructions"
                    placeholder="{{
                      current_language_set?.Prescription?.instructions
                    }}"
                  />
                </mat-form-field>
              </div>
              <div class="col-md-1 centered-button">
                <button
                  mat-mini-fab
                  id="editMedicine"
                  (click)="editMedicine(j, drug.value.id)"
                  color="primary"
                >
                  <span class="material-icons">edit</span>
                </button>
                <button
                  style="margin-left: 10px"
                  mat-mini-fab
                  id="deleteMedicine"
                  (click)="deleteMedicine(j, drug.value.id)"
                  color="warn"
                >
                  <span class="material-icons">close</span>
                </button>
              </div>
            </div>
          </fieldset>
        </ng-container>
      </div>
    </div>
  </div>
  <mat-paginator
    [length]="drugPrescriptionForm?.controls.prescribedDrugs?.value.length"
    [pageSize]="pageSize"
    hidePageSize="true"
    (page)="setLimits($event.pageIndex)"
  >
  </mat-paginator>
</div>

<div class="row m-t-20" [formGroup]="prescriptionCounsellingForm">
  <div
    class="col-xs-12 col-sm-12 col-md-4 col-lg-4 dropdown-height"
    *ngIf="
      visitCategory !== undefined &&
      visitCategory.toLowerCase() !== 'covid===================-19 screening' &&
      visitCategory.toLowerCase() !==
        'fp & =========================================================================================contraceptive services'
    "
  >
    <div class="form-group">
      <mat-select
        multiple
        class="input-full-width"
        placeholder="{{ current_language_set?.counsellingProvided }}"
        formControlName="counsellingProvidedList"
        id="prescriptionAndCounselling"
        name="prescriptionAndCounselling"
        (change)="
          counsellingProvidedoneOptionValidation(prescriptionAndCounselling)
        "
      >
        <mat-option
          class="dropdownValue"
          *ngFor="let counselling of counsellingProvidedList"
          [value]="counselling.name"
          [disabled]="
            disableNoneOption !== null &&
            ((!disableNoneOption && counselling.name === 'None') ||
 ===================             (disableNoneOption && counselling.name !== 'None'))
   =       "
        >
          {{ counselling.name }}
        </mat-option>
      </mat-select>
    </div>
  </div>
  <div
    class="col-md-10 box"
    *ngIf="
      visitCategory !== undefined &&
      (visitCategory.toLowerCase() ===
        'covid===================-19 screening' ||
        visitCategory.toLowerCase() ===
          'fp & =========================================================================================contraceptive services')
    "
  >
    <mat-form-field class="input-full-width">
      <textarea
        matInput
        defaultNull
        maxlength="500"
        allowText="textAreaValidator"
        matTextareaAutosize
        class="input-full-width"
        placeholder="{{ current_language_set?.counsellingProvided }}"
        formControlName="counsellingProvidedList"
        id="prescriptionAndCounselling"
        name="prescriptionAndCounselling"
      ></textarea>
    </mat-form-field>
  </div>
</div>
